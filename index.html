<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OdinSight Tech Maturity Assessment</title>
    <style>
        :root {
            --primary: #4a9bd7;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --dark: #0a1622;
            --darker: #050d16;
            --light: #ecf0f1;
            --text-light: #ecf0f1;
            --text-dark: #2c3e50;
            --border-radius: 4px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--darker);
            color: var(--text-light);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background-color: var(--dark);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(74, 155, 215, 0.2);
        }

        h1, h2, h3, h4 {
            color: var(--primary);
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light);
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(74, 155, 215, 0.3);
            border-radius: var(--border-radius);
            background-color: rgba(10, 22, 34, 0.8);
            color: var(--text-light);
            font-size: 16px;
            box-sizing: border-box;
        }

        /* Style for dropdown arrow */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
        }

        /* Remove default appearance */
        select::-ms-expand {
            display: none;
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Style for dropdown options */
        select option {
            background-color: var(--dark);
            color: var(--text-light);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(74, 155, 215, 0.5);
            background-color: rgba(255, 255, 255, 0.15);
        }

        button {
            background-color: rgba(74, 155, 215, 0.2);
            color: var(--text-light);
            border: 1px solid var(--primary);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            background-color: rgba(74, 155, 215, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            background-color: rgba(74, 155, 215, 0.1);
            border-color: rgba(74, 155, 215, 0.2);
            color: rgba(236, 240, 241, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--darker);
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            padding: 30px;
            background-color: var(--dark);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(74, 155, 215, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-form {
            margin-top: 20px;
        }

        .login-btn {
            width: 100%;
            margin-top: 20px;
            padding: 12px;
            font-size: 18px;
        }

        .login-error {
            color: var(--danger);
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
            min-height: 20px;
        }

        .register-link {
            margin-top: 20px;
            text-align: center;
        }

        .register-link a {
            color: var(--primary);
            text-decoration: none;
        }

        .register-link a:hover {
            text-decoration: underline;
        }

        .register-form {
            display: none;
        }

        .back-to-login {
            margin-top: 20px;
            text-align: center;
        }

        .back-to-login a {
            color: var(--primary);
            text-decoration: none;
        }

        .back-to-login a:hover {
            text-decoration: underline;
        }

        header {
            background-color: var(--dark);
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(74, 155, 215, 0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome-message {
            max-width: 70%;
        }

        .welcome-message h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .welcome-message h2 {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--secondary);
        }

        .welcome-message p {
            color: rgba(236, 240, 241, 0.8);
            font-size: 14px;
        }

        .logout-container {
            text-align: right;
        }

        .logout-btn {
            background-color: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .logout-btn:hover {
            background-color: rgba(231, 76, 60, 0.1);
        }

        .tab-navigation {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(74, 155, 215, 0.2);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            color: var(--text-light);
            font-weight: 600;
            position: relative;
            transition: all 0.3s;
            box-shadow: none;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .app-selection-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .app-selection-form select {
            flex: 1;
        }

        .selected-apps {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .app-tag {
            background-color: rgba(74, 155, 215, 0.1);
            border: 1px solid rgba(74, 155, 215, 0.3);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
        }

        .app-tag span {
            margin-right: 8px;
        }

        .remove-app {
            cursor: pointer;
            color: var(--danger);
            font-weight: bold;
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
        }

        .profile-info {
            margin-bottom: 20px;
        }

        .profile-info p {
            margin-bottom: 10px;
            display: flex;
        }

        .profile-info p strong {
            min-width: 200px;
            display: inline-block;
        }

        .edit-profile-form {
            display: none;
        }

        .results-section {
            margin-bottom: 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .app-details {
            background-color: rgba(10, 22, 34, 0.5);
            border: 1px solid rgba(74, 155, 215, 0.2);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }

        .app-details h3 {
            margin-bottom: 10px;
        }

        .score-bar {
            height: 8px;
            background-color: rgba(74, 155, 215, 0.1);
            border-radius: 4px;
            margin: 5px 0 15px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background-color: var(--primary);
        }

        .app-rankings {
            list-style: none;
            padding: 0;
        }

        .app-ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(74, 155, 215, 0.1);
        }

        .app-score {
            font-weight: bold;
            color: var(--primary);
        }

        .recommendations {
            list-style: none;
            padding: 0;
        }

        .recommendation-item {
            padding: 10px;
            border-bottom: 1px solid rgba(74, 155, 215, 0.1);
        }

        .recommendation-priority {
            font-weight: bold;
            margin-right: 5px;
        }

        .priority-high {
            color: var(--danger);
        }

        .priority-medium {
            color: #f39c12;
        }

        .priority-low {
            color: var(--secondary);
        }

        .maturity-score-container {
            text-align: center;
            margin: 30px 0;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 8px solid var(--primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }

        .score-value {
            font-size: 36px;
            font-weight: bold;
            color: var(--primary);
        }

        .score-label {
            font-size: 12px;
            color: rgba(236, 240, 241, 0.7);
        }

        .score-level {
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
        }

        .maturity-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .maturity-category {
            background-color: rgba(10, 22, 34, 0.5);
            border: 1px solid rgba(74, 155, 215, 0.2);
            padding: 15px;
            border-radius: var(--border-radius);
        }

        .category-score {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .timeline {
            position: relative;
            margin: 20px 0;
            padding-left: 30px;
        }

        .timeline:before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 2px;
            background-color: rgba(74, 155, 215, 0.3);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
        }

        .timeline-item:before {
            content: '';
            position: absolute;
            left: -36px;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--primary);
        }

        .timeline-date {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .timeline-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .timeline-tasks {
            list-style: none;
            padding: 0;
            margin-bottom: 10px;
        }

        .timeline-tasks li {
            margin-bottom: 5px;
            position: relative;
            padding-left: 20px;
        }

        .timeline-tasks li:before {
            content: '•';
            position: absolute;
            left: 0;
            color: var(--primary);
        }

        .user-list {
            list-style: none;
            padding: 0;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(74, 155, 215, 0.1);
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .welcome-message {
                max-width: 100%;
                margin-bottom: 20px;
            }

            .logout-container {
                text-align: left;
            }

            .app-selection-form {
                flex-direction: column;
            }

            .maturity-categories {
                grid-template-columns: 1fr;
            }
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- Login Container (initially visible) -->
    <div id="login-container" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>OdinSight</h1>
                <h2>Tech Maturity Assessment</h2>
                <p>Please log in to access the assessment tool</p>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" placeholder="Enter your username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <div id="login-error" class="login-error"></div>
                <button id="login-btn" class="login-btn">Log In</button>
                <div class="register-link">
                    <a href="#" id="show-register">Don't have an account? Register here</a>
                </div>
            </div>
            <div class="register-form" id="register-form">
                <div class="form-group">
                    <label for="reg-username">Username:</label>
                    <input type="text" id="reg-username" placeholder="Choose a username" required>
                </div>
                <div class="form-group">
                    <label for="reg-password">Password:</label>
                    <input type="password" id="reg-password" placeholder="Choose a password" required>
                </div>
                <div class="form-group">
                    <label for="reg-role">Role:</label>
                    <select id="reg-role" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div id="register-error" class="login-error"></div>
                <button id="register-btn" class="login-btn">Register</button>
                <div class="back-to-login">
                    <a href="#" id="show-login">Already have an account? Log in here</a>
                </div>
            </div>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="welcome-message">
                        <h1>Welcome to the Tech Maturity Assessment by OdinSight</h1>
                        <h2>Provided by Odin Tech Forge</h2>
                        <p>Our intuitive and well-designed assessment quickly evaluates your organization's technology maturity. You'll receive a comprehensive Tech Maturity Score along with tailored recommendations to guide your next steps, while effectively identifying both risks and opportunities.</p>
                    </div>
                    <div class="logout-container">
                        <button id="logout-btn" class="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="tab-navigation">
                <button class="tab active" data-tab="assessment">Assessment</button>
                <button class="tab" data-tab="profile">Company Profile</button>
                <div id="admin-tab-container" style="display: none;">
                    <button class="tab" data-tab="admin">Admin Panel</button>
                </div>
            </div>

            <div id="assessment-tab" class="tab-content active">
                <!-- App Selection Section -->
                <div class="card">
                    <h2>Select Applications</h2>
                    <p>Select up to 8 applications to assess their maturity and optimization potential.</p>
                    
                    <div class="app-selection-form">
                        <select id="category">
                            <option value="">Select Category</option>
                            <option value="Email">Email</option>
                            <option value="Productivity">Productivity</option>
                            <option value="Communication">Communication</option>
                            <option value="Project Management">Project Management</option>
                            <option value="CRM">CRM</option>
                            <option value="Analytics">Analytics</option>
                            <option value="Finance">Finance</option>
                            <option value="HR">HR</option>
                        </select>
                        <select id="app" disabled>
                            <option value="">Select App</option>
                        </select>
                        <button id="add-app-btn" disabled>Add App</button>
                    </div>
                    
                    <div id="selected-apps" class="selected-apps">
                        <div id="no-apps-message">No apps selected. Please select up to 8 apps to assess.</div>
                    </div>
                    
                    <button id="calculate-btn" disabled>Calculate Optimization Steps</button>
                </div>
                
                <!-- Results Section (initially hidden) -->
                <div id="results" class="card" style="display: none;">
                    <div class="results-header">
                        <h2>Assessment Results</h2>
                        <button id="download-pdf-btn">Download PDF Report</button>
                    </div>
                    
                    <div class="results-section">
                        <h3>Current App Details</h3>
                        <div id="current-app-details"></div>
                    </div>
                    
                    <div class="results-section">
                        <h3>App Rankings</h3>
                        <ul id="app-rankings" class="app-rankings"></ul>
                    </div>
                    
                    <div class="results-section">
                        <h3>Optimization Recommendations</h3>
                        <ul id="recommendations" class="recommendations"></ul>
                    </div>
                    
                    <div class="results-section">
                        <h3>Maturity Score</h3>
                        <div id="maturity-score" class="maturity-score-container"></div>
                        <div id="maturity-categories" class="maturity-categories"></div>
                    </div>
                    
                    <div class="results-section">
                        <h3>Implementation Plan</h3>
                        <div id="implementation-plan" class="timeline"></div>
                    </div>
                </div>
            </div>
            
            <div id="profile-tab" class="tab-content">
                <div class="card">
                    <div class="profile-header">
                        <h2>Company Profile</h2>
                        <div class="profile-actions">
                            <button id="edit-profile-btn">Edit Profile</button>
                            <button id="save-profile-btn">Save Profile</button>
                        </div>
                    </div>
                    
                    <div id="profile-info" class="profile-info">
                        <!-- Profile information will be displayed here -->
                        <p>Loading profile information...</p>
                    </div>
                    
                    <div id="edit-profile-form" class="edit-profile-form">
                        <div class="form-group">
                            <label for="edit-company-name">Company Name:</label>
                            <input type="text" id="edit-company-name" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-team-size">Team Size:</label>
                            <select id="edit-team-size" required>
                                <option value="1-10">1-10</option>
                                <option value="11-50">11-50</option>
                                <option value="51-200">51-200</option>
                                <option value="200+">200+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-infrastructure">Infrastructure:</label>
                            <select id="edit-infrastructure" required>
                                <option value="On-premise">On-premise</option>
                                <option value="Hybrid">Hybrid</option>
                                <option value="Cloud-first (AWS, Azure, GCP)">Cloud-first (AWS, Azure, GCP)</option>
                                <option value="Fully automated cloud-native">Fully automated cloud-native</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-disaster-recovery">Disaster Recovery:</label>
                            <select id="edit-disaster-recovery" required>
                                <option value="No backups">No backups</option>
                                <option value="Manual occasionally">Manual occasionally</option>
                                <option value="Automated daily">Automated daily</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-security">Security:</label>
                            <select id="edit-security" required>
                                <option value="None">None</option>
                                <option value="Ad-hoc">Ad-hoc</option>
                                <option value="Regular vulnerability scans">Regular vulnerability scans</option>
                                <option value="Formal framework (ISO 27001, SOC2)">Formal framework (ISO 27001, SOC2)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-gdpr">GDPR Compliance:</label>
                            <select id="edit-gdpr" required>
                                <option value="None">None</option>
                                <option value="In progress">In progress</option>
                                <option value="Fully compliant with audits">Fully compliant with audits</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-deployment">Deployment Process:</label>
                            <select id="edit-deployment" required>
                                <option value="Manual">Manual</option>
                                <option value="Basic CI/CD">Basic CI/CD</option>
                                <option value="Automated CI/CD + testing">Automated CI/CD + testing</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-version-control">Version Control:</label>
                            <select id="edit-version-control" required>
                                <option value="No">No</option>
                                <option value="Yes, but inconsistently">Yes, but inconsistently</option>
                                <option value="Yes, fully standardized">Yes, fully standardized</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-cto">Technical Leadership:</label>
                            <select id="edit-cto" required>
                                <option value="No dedicated tech leader">No dedicated tech leader</option>
                                <option value="Part-time/fractional support">Part-time/fractional support</option>
                                <option value="Dedicated CTO">Dedicated CTO</option>
                                <option value="CTO + leadership team">CTO + leadership team</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-roadmap">Technical Roadmap Review:</label>
                            <select id="edit-roadmap" required>
                                <option value="Never">Never</option>
                                <option value="Once a year">Once a year</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Continuous">Continuous</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-ai-usage">AI Usage:</label>
                            <select id="edit-ai-usage" required>
                                <option value="Not at all">Not at all</option>
                                <option value="Experimenting in some departments">Experimenting in some departments</option>
                                <option value="Integrated into workflows (e.g., analytics, automation)">Integrated into workflows (e.g., analytics, automation)</option>
                                <option value="Core part of products/services">Core part of products/services</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-ai-strategy">AI Strategy:</label>
                            <select id="edit-ai-strategy" required>
                                <option value="No strategy/policy">No strategy/policy</option>
                                <option value="Some guidelines, not standardized">Some guidelines, not standardized</option>
                                <option value="Formal AI strategy in progress">Formal AI strategy in progress</option>
                                <option value="Comprehensive AI strategy with governance">Comprehensive AI strategy with governance</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-ai-ethics">AI Ethics & Governance:</label>
                            <select id="edit-ai-ethics" required>
                                <option value="Not considered">Not considered</option>
                                <option value="Ad-hoc awareness">Ad-hoc awareness</option>
                                <option value="Formal reviews & partial safeguards">Formal reviews & partial safeguards</option>
                                <option value="Fully established AI governance framework">Fully established AI governance framework</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="admin-tab" class="tab-content">
                <div class="card">
                    <h2>User Management</h2>
                    <div id="user-list" class="user-list">
                        <p>Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Define API_URL once - this is the only place it should be defined
        const API_URL = 'https://odin-sight-backend.vercel.app/api';

        // DOM Elements
        const loginContainer = document.getElementById('login-container');
        const mainContent = document.getElementById('main-content');
        const loginForm = document.querySelector('.login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const adminTabContainer = document.getElementById('admin-tab-container');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const profileInfo = document.getElementById('profile-info');
        const editProfileForm = document.getElementById('edit-profile-form');
        const userList = document.getElementById('user-list');

        // App selection elements
        const categorySelect = document.getElementById('category');
        const appSelect = document.getElementById('app');
        const addAppBtn = document.getElementById('add-app-btn');
        const selectedAppsDiv = document.getElementById('selected-apps');
        const noAppsMessage = document.getElementById('no-apps-message');
        const calculateBtn = document.getElementById('calculate-btn');
        const resultsDiv = document.getElementById('results');
        const currentAppDetails = document.getElementById('current-app-details');
        const recommendationsDiv = document.getElementById('recommendations');
        const appRankingsDiv = document.getElementById('app-rankings');
        const maturityScoreDiv = document.getElementById('maturity-score');
        const maturityCategoriesDiv = document.getElementById('maturity-categories');
        const implementationPlanDiv = document.getElementById('implementation-plan');

        // Array to store selected apps
        let selectedApps = [];
        const MAX_APPS = 8;

        // App data
        const appData = {
            "Email": [
                {
                    name: "Gmail",
                    category: "Email",
                    overallScore: 4.5,
                    functionality: 4,
                    userExperience: 5,
                    integration: 4,
                    security: 5,
                    cost: 4,
                    description: "Google's email service with strong integration with other Google products."
                },
                {
                    name: "Outlook",
                    category: "Email",
                    overallScore: 4.3,
                    functionality: 5,
                    userExperience: 4,
                    integration: 5,
                    security: 4,
                    cost: 3,
                    description: "Microsoft's email client with strong integration with Office 365."
                },
                {
                    name: "ProtonMail",
                    category: "Email",
                    overallScore: 4.0,
                    functionality: 3,
                    userExperience: 4,
                    integration: 3,
                    security: 5,
                    cost: 3,
                    description: "Secure email service with end-to-end encryption."
                }
            ],
            "Productivity": [
                {
                    name: "Microsoft Office",
                    category: "Productivity",
                    overallScore: 4.7,
                    functionality: 5,
                    userExperience: 4,
                    integration: 5,
                    security: 4,
                    cost: 3,
                    description: "Comprehensive office suite with Word, Excel, PowerPoint, and more."
                },
                {
                    name: "Google Workspace",
                    category: "Productivity",
                    overallScore: 4.5,
                    functionality: 4,
                    userExperience: 5,
                    integration: 5,
                    security: 4,
                    cost: 4,
                    description: "Cloud-based productivity suite with Docs, Sheets, Slides, and more."
                },
                {
                    name: "LibreOffice",
                    category: "Productivity",
                    overallScore: 3.8,
                    functionality: 4,
                    userExperience: 3,
                    integration: 3,
                    security: 4,
                    cost: 5,
                    description: "Free and open-source office suite."
                }
            ],
            "Communication": [
                {
                    name: "Slack",
                    category: "Communication",
                    overallScore: 4.6,
                    functionality: 5,
                    userExperience: 4,
                    integration: 5,
                    security: 4,
                    cost: 3,
                    description: "Channel-based messaging platform for teams."
                },
                {
                    name: "Microsoft Teams",
                    category: "Communication",
                    overallScore: 4.4,
                    functionality: 5,
                    userExperience: 4,
                    integration: 5,
                    security: 4,
                    cost: 3,
                    description: "Unified communication and collaboration platform."
                },
                {
                    name: "Discord",
                    category: "Communication",
                    overallScore: 4.2,
                    functionality: 4,
                    userExperience: 5,
                    integration: 3,
                    security: 3,
                    cost: 5,
                    description: "Voice, video, and text communication platform."
                }
            ],
            "Project Management": [
                {
                    name: "Jira",
                    category: "Project Management",
                    overallScore: 4.5,
                    functionality: 5,
                    userExperience: 3,
                    integration: 5,
                    security: 4,
                    cost: 3,
                    description: "Issue tracking and project management tool for software teams."
                },
                {
                    name: "Asana",
                    category: "Project Management",
                    overallScore: 4.3,
                    functionality: 4,
                    userExperience: 5,
                    integration: 4,
                    security: 4,
                    cost: 3,
                    description: "Work management platform for teams."
                },
                {
                    name: "Trello",
                    category: "Project Management",
                    overallScore: 4.1,
                    functionality: 3,
                    userExperience: 5,
                    integration: 4,
                    security: 4,
                    cost: 4,
                    description: "Visual tool for organizing work with boards, lists, and cards."
                }
            ],
            "CRM": [
                {
                    name: "Salesforce",
                    category: "CRM",
                    overallScore: 4.7,
                    functionality: 5,
                    userExperience: 4,
                    integration: 5,
                    security: 5,
                    cost: 2,
                    description: "Customer relationship management platform with extensive customization."
                },
                {
                    name: "HubSpot",
                    category: "CRM",
                    overallScore: 4.4,
                    functionality: 4,
                    userExperience: 5,
                    integration: 4,
                    security: 4,
                    cost: 3,
                    description: "CRM platform with marketing, sales, and service hubs."
                },
                {
                    name: "Zoho CRM",
                    category: "CRM",
                    overallScore: 4.2,
                    functionality: 4,
                    userExperience: 4,
                    integration: 4,
                    security: 4,
                    cost: 4,
                    description: "Web-based CRM solution for managing sales, marketing, and support."
                }
            ],
            "Analytics": [
                {
                    name: "Google Analytics",
                    category: "Analytics",
                    overallScore: 4.6,
                    functionality: 5,
                    userExperience: 4,
                    integration: 5,
                    security: 4,
                    cost: 5,
                    description: "Web analytics service that tracks and reports website traffic."
                },
                {
                    name: "Tableau",
                    category: "Analytics",
                    overallScore: 4.5,
                    functionality: 5,
                    userExperience: 4,
                    integration: 4,
                    security: 4,
                    cost: 2,
                    description: "Interactive data visualization software focused on business intelligence."
                },
                {
                    name: "Power BI",
                    category: "Analytics",
                    overallScore: 4.4,
                    functionality: 5,
                    userExperience: 4,
                    integration: 5,
                    security: 4,
                    cost: 3,
                    description: "Business analytics service by Microsoft for interactive visualizations."
                }
            ],
            "Finance": [
                {
                    name: "QuickBooks",
                    category: "Finance",
                    overallScore: 4.5,
                    functionality: 5,
                    userExperience: 4,
                    integration: 4,
                    security: 5,
                    cost: 3,
                    description: "Accounting software for small and medium-sized businesses."
                },
                {
                    name: "Xero",
                    category: "Finance",
                    overallScore: 4.3,
                    functionality: 4,
                    userExperience: 5,
                    integration: 4,
                    security: 4,
                    cost: 3,
                    description: "Cloud-based accounting software for small businesses."
                },
                {
                    name: "FreshBooks",
                    category: "Finance",
                    overallScore: 4.1,
                    functionality: 4,
                    userExperience: 5,
                    integration: 3,
                    security: 4,
                    cost: 3,
                    description: "Cloud-based accounting software designed for small businesses."
                }
            ],
            "HR": [
                {
                    name: "BambooHR",
                    category: "HR",
                    overallScore: 4.4,
                    functionality: 4,
                    userExperience: 5,
                    integration: 4,
                    security: 4,
                    cost: 3,
                    description: "HR software for small and medium-sized businesses."
                },
                {
                    name: "Workday",
                    category: "HR",
                    overallScore: 4.6,
                    functionality: 5,
                    userExperience: 4,
                    integration: 5,
                    security: 5,
                    cost: 2,
                    description: "Cloud-based HR and financial management software."
                },
                {
                    name: "Gusto",
                    category: "HR",
                    overallScore: 4.3,
                    functionality: 4,
                    userExperience: 5,
                    integration: 4,
                    security: 4,
                    cost: 3,
                    description: "Payroll, benefits, and HR management software for small businesses."
                }
            ]
        };

        // Show register form
        showRegisterLink.addEventListener('click', function(e) {
            e.preventDefault();
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
        });

        // Show login form
        showLoginLink.addEventListener('click', function(e) {
            e.preventDefault();
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
        });

        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Remove active class from all tabs and contents
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                this.classList.add('active');
                document.getElementById(tabId + '-tab').classList.add('active');
            });
        });

        // Profile editing
        editProfileBtn.addEventListener('click', function() {
            profileInfo.style.display = 'none';
            editProfileForm.style.display = 'block';
        });

        // Category selection
        categorySelect.addEventListener('change', function() {
            const category = this.value;
            appSelect.innerHTML = '<option value="">Select App</option>';
            
            if (category) {
                const apps = appData[category] || [];
                apps.forEach(app => {
                    const option = document.createElement('option');
                    option.value = app.name;
                    option.textContent = app.name;
                    appSelect.appendChild(option);
                });
                appSelect.disabled = false;
            } else {
                appSelect.disabled = true;
            }
            
            addAppBtn.disabled = true;
        });

        // App selection
        appSelect.addEventListener('change', function() {
            addAppBtn.disabled = !this.value;
        });

        // Add app
        addAppBtn.addEventListener('click', function() {
            const category = categorySelect.value;
            const appName = appSelect.value;
            
            if (!category || !appName) return;
            
            // Check if app is already selected
            if (selectedApps.some(app => app.name === appName)) {
                alert('This app is already selected.');
                return;
            }
            
            // Check if maximum apps reached
            if (selectedApps.length >= MAX_APPS) {
                alert(`You can select a maximum of ${MAX_APPS} apps.`);
                return;
            }
            
            // Find app data
            const app = appData[category].find(a => a.name === appName);
            
            // Add to selected apps
            selectedApps.push(app);
            
            // Update UI
            updateSelectedAppsUI();
            
            // Reset selections
            appSelect.value = '';
            addAppBtn.disabled = true;
        });

        // Update selected apps UI
        function updateSelectedAppsUI() {
            if (selectedApps.length === 0) {
                noAppsMessage.style.display = 'block';
                calculateBtn.disabled = true;
            } else {
                noAppsMessage.style.display = 'none';
                calculateBtn.disabled = false;
                
                // Clear and rebuild selected apps
                selectedAppsDiv.innerHTML = '';
                selectedApps.forEach((app, index) => {
                    const appTag = document.createElement('div');
                    appTag.className = 'app-tag';
                    appTag.innerHTML = `
                        <span>${app.name} (${app.category})</span>
                        <span class="remove-app" data-index="${index}">✕</span>
                    `;
                    selectedAppsDiv.appendChild(appTag);
                });
                
                // Add remove event listeners
                document.querySelectorAll('.remove-app').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        selectedApps.splice(index, 1);
                        updateSelectedAppsUI();
                    });
                });
                
                // Add no apps message back if needed
                if (selectedApps.length === 0) {
                    selectedAppsDiv.appendChild(noAppsMessage);
                }
            }
        }

        // Calculate optimization steps
        calculateBtn.addEventListener('click', function() {
            if (selectedApps.length === 0) return;
            
            // Sort apps by overall score
            const rankedApps = [...selectedApps].sort((a, b) => b.overallScore - a.overallScore);
            
            // Calculate maturity score
            const maturityScore = calculateMaturityScore();
            
            // Generate recommendations
            const recommendations = generateRecommendations();
            
            // Generate implementation plan
            const implementationPlan = generateImplementationPlan();
            
            // Display results
            displayResults(rankedApps, maturityScore, recommendations, implementationPlan);
            
            // Show results container
            resultsDiv.style.display = 'block';
        });

        // Calculate maturity score
        function calculateMaturityScore() {
            // Base score from selected apps
            const appScoreAvg = selectedApps.reduce((sum, app) => sum + app.overallScore, 0) / selectedApps.length;
            const appScore = (appScoreAvg / 5) * 100;
            
            // Get profile data if available
            let profileScore = 50; // Default if no profile
            try {
                const infrastructure = document.getElementById('edit-infrastructure').value;
                const security = document.getElementById('edit-security').value;
                const deployment = document.getElementById('edit-deployment').value;
                
                // Calculate profile score based on key technical factors
                let infraScore = 0;
                if (infrastructure === 'Fully automated cloud-native') infraScore = 100;
                else if (infrastructure === 'Cloud-first (AWS, Azure, GCP)') infraScore = 75;
                else if (infrastructure === 'Hybrid') infraScore = 50;
                else infraScore = 25;
                
                let secScore = 0;
                if (security === 'Formal framework (ISO 27001, SOC2)') secScore = 100;
                else if (security === 'Regular vulnerability scans') secScore = 75;
                else if (security === 'Ad-hoc') secScore = 50;
                else secScore = 25;
                
                let deployScore = 0;
                if (deployment === 'Automated CI/CD + testing') deployScore = 100;
                else if (deployment === 'Basic CI/CD') deployScore = 60;
                else deployScore = 30;
                
                profileScore = (infraScore + secScore + deployScore) / 3;
            } catch (e) {
                console.log('Could not calculate profile score, using default', e);
            }
            
            // Combine scores (60% app selection, 40% profile)
            return Math.round((appScore * 0.6) + (profileScore * 0.4));
        }

        // Generate recommendations
        function generateRecommendations() {
            const recommendations = [];
            
            // Check for missing categories
            const selectedCategories = new Set(selectedApps.map(app => app.category));
            const allCategories = Object.keys(appData);
            const missingCategories = allCategories.filter(cat => !selectedCategories.has(cat));
            
            if (missingCategories.length > 0) {
                missingCategories.forEach(category => {
                    const bestApp = appData[category].reduce((best, app) => 
                        app.overallScore > best.overallScore ? app : best, appData[category][0]);
                    
                    recommendations.push({
                        priority: 'High',
                        text: `Add ${bestApp.name} to cover the ${category} category in your tech stack.`
                    });
                });
            }
            
            // Check for low-scoring apps
            selectedApps.forEach(app => {
                if (app.overallScore < 4.0) {
                    // Find better alternative in same category
                    const betterApps = appData[app.category].filter(a => 
                        a.name !== app.name && a.overallScore > app.overallScore);
                    
                    if (betterApps.length > 0) {
                        const bestAlternative = betterApps.reduce((best, current) => 
                            current.overallScore > best.overallScore ? current : best, betterApps[0]);
                        
                        recommendations.push({
                            priority: 'Medium',
                            text: `Consider replacing ${app.name} with ${bestAlternative.name} for better performance in ${app.category}.`
                        });
                    }
                }
            });
            
            // Add general recommendations
            recommendations.push({
                priority: 'Medium',
                text: 'Implement single sign-on (SSO) across all applications to improve security and user experience.'
            });
            
            recommendations.push({
                priority: 'Low',
                text: 'Schedule quarterly reviews of your tech stack to ensure it continues to meet your business needs.'
            });
            
            return recommendations;
        }

        // Generate implementation plan
        function generateImplementationPlan() {
            return [
                {
                    title: "Phase 1: Assessment & Planning (1-2 weeks)",
                    timeline: "Weeks 1-2",
                    tasks: [
                        "Document current tech stack and processes",
                        "Identify key stakeholders and form implementation team",
                        "Define success metrics and KPIs",
                        "Create detailed implementation roadmap"
                    ],
                    resources: "Internal team time, potentially external consultant for assessment"
                },
                {
                    title: "Phase 2: Foundation Building (2-4 weeks)",
                    timeline: "Weeks 3-6",
                    tasks: [
                        "Set up core infrastructure improvements",
                        "Implement security enhancements",
                        "Establish governance framework",
                        "Begin staff training on new systems"
                    ],
                    resources: "IT team time, training resources, potential infrastructure costs"
                },
                {
                    title: "Phase 3: Implementation & Integration (1-3 months)",
                    timeline: "Months 2-4",
                    tasks: [
                        "Deploy new applications in staged rollout",
                        "Integrate systems and establish data flows",
                        "Develop metrics dashboard for technology performance",
                        "Begin pilot projects for new technologies"
                    ],
                    resources: "May require external consultants for specialized integration work"
                },
                {
                    title: "Phase 4: Innovation & Scaling (6-12 months)",
                    timeline: "Months 6-12",
                    tasks: [
                        "Evaluate emerging technologies for business impact",
                        "Scale successful pilot projects across organization",
                        "Optimize processes based on performance data",
                        "Develop long-term technology roadmap"
                    ],
                    resources: "Innovation budget, R&D resources, potential new hires"
                }
            ];
        }

        // Display results
        function displayResults(rankedApps, maturityScore, recommendations, implementationPlan) {
            // Display app rankings
            appRankingsDiv.innerHTML = '';
            rankedApps.forEach(app => {
                const li = document.createElement('li');
                li.className = 'app-ranking-item';
                li.innerHTML = `
                    <div>${app.name} (${app.category})</div>
                    <div class="app-score">${app.overallScore}/5</div>
                `;
                appRankingsDiv.appendChild(li);
            });
            
            // Display recommendations
            recommendationsDiv.innerHTML = '';
            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.className = 'recommendation-item';
                li.innerHTML = `
                    <span class="recommendation-priority priority-${rec.priority.toLowerCase()}">${rec.priority}:</span>
                    ${rec.text}
                `;
                recommendationsDiv.appendChild(li);
            });
            
            // Display maturity score
            let maturityLevel, maturityColor;
            if (maturityScore >= 80) {
                maturityLevel = "Advanced";
                maturityColor = "#2ecc71";
            } else if (maturityScore >= 60) {
                maturityLevel = "Established";
                maturityColor = "#3498db";
            } else if (maturityScore >= 40) {
                maturityLevel = "Developing";
                maturityColor = "#f39c12";
            } else {
                maturityLevel = "Basic";
                maturityColor = "#e74c3c";
            }
            
            maturityScoreDiv.innerHTML = `
                <div class="score-circle" style="border-color: ${maturityColor}">
                    <div class="score-value" style="color: ${maturityColor}">${maturityScore}</div>
                    <div class="score-label">Tech Maturity Score</div>
                    <div class="score-level" style="color: ${maturityColor}">${maturityLevel}</div>
                </div>
            `;
            
            // Display maturity categories
            maturityCategoriesDiv.innerHTML = '';
            
            // Create category scores
            const categories = [
                { name: 'Application Selection', score: calculateCategoryScore('apps') },
                { name: 'Infrastructure', score: calculateCategoryScore('infrastructure') },
                { name: 'Security', score: calculateCategoryScore('security') },
                { name: 'Development Practices', score: calculateCategoryScore('development') }
            ];
            
            categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'maturity-category';
                div.innerHTML = `
                    <h4>${category.name}</h4>
                    <div class="category-score">${category.score}/100</div>
                    <div class="score-bar">
                        <div class="score-fill" style="width: ${category.score}%"></div>
                    </div>
                `;
                maturityCategoriesDiv.appendChild(div);
            });
            
            // Display app details
            currentAppDetails.innerHTML = '';
            selectedApps.forEach(app => {
                const div = document.createElement('div');
                div.className = 'app-details';
                div.innerHTML = `
                    <h3>${app.name} (${app.category})</h3>
                    <p>${app.description}</p>
                    <div>
                        <strong>Functionality:</strong> ${app.functionality}/5
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${app.functionality * 20}%"></div>
                        </div>
                    </div>
                    <div>
                        <strong>User Experience:</strong> ${app.userExperience}/5
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${app.userExperience * 20}%"></div>
                        </div>
                    </div>
                    <div>
                        <strong>Integration:</strong> ${app.integration}/5
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${app.integration * 20}%"></div>
                        </div>
                    </div>
                    <div>
                        <strong>Security:</strong> ${app.security}/5
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${app.security * 20}%"></div>
                        </div>
                    </div>
                    <div>
                        <strong>Cost Efficiency:</strong> ${app.cost}/5
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${app.cost * 20}%"></div>
                        </div>
                    </div>
                `;
                currentAppDetails.appendChild(div);
            });
            
            // Display implementation plan
            implementationPlanDiv.innerHTML = '';
            implementationPlan.forEach(phase => {
                const div = document.createElement('div');
                div.className = 'timeline-item';
                
                let tasksHTML = '';
                phase.tasks.forEach(task => {
                    tasksHTML += `<li>${task}</li>`;
                });
                
                div.innerHTML = `
                    <div class="timeline-date">${phase.timeline}</div>
                    <div class="timeline-title">${phase.title}</div>
                    <ul class="timeline-tasks">
                        ${tasksHTML}
                    </ul>
                    <div class="timeline-resources"><strong>Resources:</strong> ${phase.resources}</div>
                `;
                
                implementationPlanDiv.appendChild(div);
            });
        }

        // Helper function to calculate category scores
        function calculateCategoryScore(category) {
            switch (category) {
                case 'apps':
                    return Math.round((selectedApps.reduce((sum, app) => sum + app.overallScore, 0) / selectedApps.length) * 20);
                case 'infrastructure':
                    try {
                        const infrastructure = document.getElementById('edit-infrastructure').value;
                        if (infrastructure === 'Fully automated cloud-native') return 90;
                        if (infrastructure === 'Cloud-first (AWS, Azure, GCP)') return 75;
                        if (infrastructure === 'Hybrid') return 50;
                        return 30;
                    } catch (e) {
                        return 50;
                    }
                case 'security':
                    try {
                        const security = document.getElementById('edit-security').value;
                        if (security === 'Formal framework (ISO 27001, SOC2)') return 90;
                        if (security === 'Regular vulnerability scans') return 70;
                        if (security === 'Ad-hoc') return 40;
                        return 20;
                    } catch (e) {
                        return 50;
                    }
                case 'development':
                    try {
                        const deployment = document.getElementById('edit-deployment').value;
                        if (deployment === 'Automated CI/CD + testing') return 90;
                        if (deployment === 'Basic CI/CD') return 60;
                        return 30;
                    } catch (e) {
                        return 50;
                    }
                default:
                    return 50;
            }
        }

        // Download PDF button
        document.getElementById('download-pdf-btn').addEventListener('click', function() {
            alert('PDF download functionality will be available in the next update. Your assessment results have been saved to your profile.');
        });

        // Authentication functions
        async function login(username, password) {
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Login failed');
                }
                
                localStorage.setItem('token', data.token);
                return data;
            } catch (error) {
                console.error('Login error:', error);
                throw error;
            }
        }

        async function register(username, password, role) {
            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password, role })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Registration failed');
                }
                
                return data;
            } catch (error) {
                console.error('Registration error:', error);
                throw error;
            }
        }

        async function getCurrentUser() {
            try {
                const token = localStorage.getItem('token');
                
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                const response = await fetch(`${API_URL}/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to get user data');
                    }
                    
                    return data;
                } else {
                    // Handle non-JSON response
                    const text = await response.text();
                    console.log('Non-JSON response:', text);
                    
                    if (!response.ok) {
                        throw new Error('Failed to get user data: Server returned non-JSON response');
                    }
                    
                    // Return a default user object
                    return { user: { username: 'User', role: 'user' } };
                }
            } catch (error) {
                console.error('Get current user error:', error);
                throw error;
            }
        }

        async function getUsers() {
            try {
                const token = localStorage.getItem('token');
                
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                const response = await fetch(`${API_URL}/auth/users`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to get users');
                    }
                    
                    return data;
                } else {
                    // Handle non-JSON response
                    const text = await response.text();
                    console.log('Non-JSON response:', text);
                    
                    if (!response.ok) {
                        throw new Error('Failed to get users: Server returned non-JSON response');
                    }
                    
                    // Return a default response
                    return { users: [] };
                }
            } catch (error) {
                console.error('Get users error:', error);
                throw error;
            }
        }

        async function getProfile() {
            try {
                const token = localStorage.getItem('token');
                
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                const response = await fetch(`${API_URL}/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to get profile');
                    }
                    
                    return data;
                } else {
                    // Handle non-JSON response
                    const text = await response.text();
                    console.log('Non-JSON response:', text);
                    
                    if (!response.ok) {
                        throw new Error('Failed to get profile: Server returned non-JSON response');
                    }
                    
                    // Return a default response
                    return { profile: null };
                }
            } catch (error) {
                console.error('Get profile error:', error);
                throw error;
            }
        }

        async function updateProfile(profileData) {
            try {
                const token = localStorage.getItem('token');
                
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                const response = await fetch(`${API_URL}/profile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(profileData)
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to update profile');
                    }
                    
                    return data;
                } else {
                    // Handle non-JSON response
                    const text = await response.text();
                    console.log('Non-JSON response:', text);
                    
                    if (!response.ok) {
                        throw new Error('Failed to update profile: Server returned non-JSON response');
                    }
                    
                    // Return a default success response
                    return { success: true, message: 'Profile updated successfully' };
                }
            } catch (error) {
                console.error('Update profile error:', error);
                throw error;
            }
        }

        async function createProfile(profileData) {
            try {
                const token = localStorage.getItem('token');
                
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                const response = await fetch(`${API_URL}/profile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(profileData)
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to create profile');
                    }
                    
                    return data;
                } else {
                    // Handle non-JSON response
                    const text = await response.text();
                    console.log('Non-JSON response:', text);
                    
                    if (!response.ok) {
                        throw new Error('Failed to create profile: Server returned non-JSON response');
                    }
                    
                    // Return a default success response
                    return { success: true, message: 'Profile created successfully' };
                }
            } catch (error) {
                console.error('Create profile error:', error);
                throw error;
            }
        }

        // Event listeners
        loginBtn.addEventListener('click', async function() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                loginError.textContent = 'Please enter both username and password';
                return;
            }
            
            try {
                loginError.textContent = '';
                const data = await login(username, password);
                
                // Show main content
                loginContainer.style.display = 'none';
                mainContent.style.display = 'block';
                
                // Load user data
                loadUserData();
            } catch (error) {
                loginError.textContent = error.message;
            }
        });

        registerBtn.addEventListener('click', async function() {
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const role = document.getElementById('reg-role').value;
            
            if (!username || !password) {
                registerError.textContent = 'Please enter both username and password';
                return;
            }
            
            try {
                registerError.textContent = '';
                await register(username, password, role);
                
                // Switch to login
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
                document.getElementById('username').value = username;
                document.getElementById('password').value = password;
                
                // Show success message
                loginError.textContent = 'Registration successful! You can now log in.';
                loginError.style.color = '#2ecc71';
            } catch (error) {
                registerError.textContent = error.message;
            }
        });

        logoutBtn.addEventListener('click', function() {
            localStorage.removeItem('token');
            mainContent.style.display = 'none';
            loginContainer.style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            loginError.textContent = '';
            loginError.style.color = '';
        });

        saveProfileBtn.addEventListener('click', async function() {
            const profileData = {
                companyName: document.getElementById('edit-company-name').value,
                teamSize: document.getElementById('edit-team-size').value,
                infrastructure: document.getElementById('edit-infrastructure').value,
                disasterRecovery: document.getElementById('edit-disaster-recovery').value,
                security: document.getElementById('edit-security').value,
                gdpr: document.getElementById('edit-gdpr').value,
                deployment: document.getElementById('edit-deployment').value,
                versionControl: document.getElementById('edit-version-control').value,
                cto: document.getElementById('edit-cto').value,
                roadmap: document.getElementById('edit-roadmap').value,
                aiUsage: document.getElementById('edit-ai-usage').value,
                aiStrategy: document.getElementById('edit-ai-strategy').value,
                aiEthics: document.getElementById('edit-ai-ethics').value,
                selectedApps: selectedApps.map(app => ({ name: app.name, category: app.category }))
            };
            
            console.log('Saving profile data:', profileData);
            
            try {
                // Try to update profile first
                try {
                    await updateProfile(profileData);
                    console.log('Profile updated successfully');
                } catch (error) {
                    console.error('Update profile error:', error);
                    // If update fails, try to create profile
                    if (error.message.includes('not found')) {
                        await createProfile(profileData);
                        console.log('Profile created successfully');
                    } else {
                        throw error;
                    }
                }
                
                // Reload profile
                await loadProfile();
                
                // Hide edit form
                profileInfo.style.display = 'block';
                editProfileForm.style.display = 'none';
                
                alert('Profile saved successfully!');
            } catch (error) {
                console.error('Save profile error:', error);
                alert('Failed to save profile: ' + error.message);
            }
        });

        // Load user data
        async function loadUserData() {
            try {
                const userData = await getCurrentUser();
                
                // Update welcome message
                document.querySelector('.welcome-message h1').textContent = `Welcome, ${userData.user.username}!`;
                
                // Show admin tab if admin
                if (userData.user.role === 'admin') {
                    adminTabContainer.style.display = 'block';
                    loadUsers();
                }
                
                // Load profile
                loadProfile();
            } catch (error) {
                console.error('Load user data error:', error);
                alert('Failed to load user data. Please log in again.');
                logoutBtn.click();
            }
        }

        // Load users (admin only)
        async function loadUsers() {
            try {
                const data = await getUsers();
                
                if (data.users && data.users.length > 0) {
                    userList.innerHTML = '';
                    
                    data.users.forEach(user => {
                        const li = document.createElement('li');
                        li.className = 'user-item';
                        li.innerHTML = `
                            <div>${user.username} (${user.role})</div>
                            <div class="user-actions">
                                <button class="view-user-btn" data-id="${user._id}">View</button>
                                <button class="delete-user-btn" data-id="${user._id}">Delete</button>
                            </div>
                        `;
                        userList.appendChild(li);
                    });
                } else {
                    userList.innerHTML = '<p>No users found.</p>';
                }
            } catch (error) {
                console.error('Load users error:', error);
                userList.innerHTML = '<p>Failed to load users.</p>';
            }
        }

        // Load profile
        async function loadProfile() {
            try {
                const data = await getProfile();
                
                if (data.profile) {
                    // Display profile info
                    profileInfo.innerHTML = `
                        <p><strong>Company Name:</strong> ${data.profile.companyName}</p>
                        <p><strong>Team Size:</strong> ${data.profile.teamSize}</p>
                        <p><strong>Infrastructure:</strong> ${data.profile.infrastructure}</p>
                        <p><strong>Disaster Recovery:</strong> ${data.profile.disasterRecovery}</p>
                        <p><strong>Security:</strong> ${data.profile.security}</p>
                        <p><strong>GDPR Compliance:</strong> ${data.profile.gdpr}</p>
                        <p><strong>Deployment Process:</strong> ${data.profile.deployment}</p>
                        <p><strong>Version Control:</strong> ${data.profile.versionControl}</p>
                        <p><strong>Technical Leadership:</strong> ${data.profile.cto}</p>
                        <p><strong>Technical Roadmap Review:</strong> ${data.profile.roadmap}</p>
                        <p><strong>AI Usage:</strong> ${data.profile.aiUsage}</p>
                        <p><strong>AI Strategy:</strong> ${data.profile.aiStrategy}</p>
                        <p><strong>AI Ethics & Governance:</strong> ${data.profile.aiEthics}</p>
                    `;
                    
                    // Set form values
                    document.getElementById('edit-company-name').value = data.profile.companyName;
                    document.getElementById('edit-team-size').value = data.profile.teamSize;
                    document.getElementById('edit-infrastructure').value = data.profile.infrastructure;
                    document.getElementById('edit-disaster-recovery').value = data.profile.disasterRecovery;
                    document.getElementById('edit-security').value = data.profile.security;
                    document.getElementById('edit-gdpr').value = data.profile.gdpr;
                    document.getElementById('edit-deployment').value = data.profile.deployment;
                    document.getElementById('edit-version-control').value = data.profile.versionControl;
                    document.getElementById('edit-cto').value = data.profile.cto;
                    document.getElementById('edit-roadmap').value = data.profile.roadmap;
                    document.getElementById('edit-ai-usage').value = data.profile.aiUsage;
                    document.getElementById('edit-ai-strategy').value = data.profile.aiStrategy;
                    document.getElementById('edit-ai-ethics').value = data.profile.aiEthics;
                    
                    // Load selected apps if available
                    if (data.profile.selectedApps && data.profile.selectedApps.length > 0) {
                        selectedApps = [];
                        
                        data.profile.selectedApps.forEach(appData => {
                            // Find the full app data from our appData object
                            const category = appData.category;
                            const appName = appData.name;
                            
                            if (appData[category]) {
                                const app = appData[category].find(a => a.name === appName);
                                if (app) {
                                    selectedApps.push(app);
                                } else {
                                    // If we can't find the exact app, create a placeholder
                                    selectedApps.push({
                                        name: appName,
                                        category: category,
                                        overallScore: 3.5,
                                        functionality: 3,
                                        userExperience: 3,
                                        integration: 3,
                                        security: 3,
                                        cost: 3,
                                        description: `${appName} from ${category} category.`
                                    });
                                }
                            }
                        });
                        
                        updateSelectedAppsUI();
                    }
                } else {
                    profileInfo.innerHTML = '<p>No profile found. Please create one.</p>';
                    
                    // Clear form values
                    document.getElementById('edit-company-name').value = '';
                }
            } catch (error) {
                console.error('Load profile error:', error);
                
                // Simplified error for display
                const simplifiedError = {
                    message: error.message || 'Unknown error'
                };
                
                if (simplifiedError.message.includes('not found')) {
                    profileInfo.innerHTML = '<p>No profile found. Please create one.</p>';
                } else {
                    profileInfo.innerHTML = `<p>Failed to load profile: ${simplifiedError.message}</p>`;
                    throw new Error('Could not load profile data: ' + simplifiedError.message);
                }
            }
        }

        // Check if user is already logged in
        if (localStorage.getItem('token')) {
            loginContainer.style.display = 'none';
            mainContent.style.display = 'block';
            loadUserData();
        }
    </script>
</body>
</html>
